<!DOCTYPE html dir="rtl">
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="TITLE OF YOUR WEBSITE">
  <meta property="og:image" content="https://github.com/roei-redler/json-as-database/blob/main/%D7%91%D7%90%D7%A0%D7%A8-4x-100.jpg?raw=true">
  <meta property="og:description" content="טופס רישום">
  <meta property="og:url" content="https://roei-redler.github.io/json-as-database/">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <title>Submit Data</title>
  <style>.day-group {
    background-color: #756d6d;
    font-weight: bold;
    text-align: center;
    color: aliceblue;
  }
  .form-group {
    text-align: right;
  }
  .banner-container {
      margin-bottom: 20px;

    }
    .banner-image {
  width: 100%;
  margin-top: 20px;
}
.table{
  text-align: center;
}
  </style>
</head>
<body>
<!DOCTYPE html> <html> <head> <title>Submit Data</title> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"> </head> <body> <div class="container">
  <div class="banner-container">
    <div class="row">
      <div class="">
        <a href="#">
          <img src="https://github.com/roei-redler/json-as-database/blob/main/%D7%91%D7%90%D7%A0%D7%A8-4x-100.jpg?raw=true" alt="Banner" class="banner-image">
        </a>
      </div>
    </div>
<div class="row" >
  <div class="col-md-6 offset-md-3">
    <h1 class="text-center my-4">רישום נוכחות</h1>


    <form id="myForm" class="card p-4" dir="rtl">
      <div class="form-group">
        <label for="name" style="text-align: right;">שם מלא:</label>
        <input type="text" name="name" placeholder="שם מלא" class="form-control" required style="text-align: right;">
      </div>
      <div class="form-group">      
        <label for="idfnumber" style="text-align: right;">הכנס מספר אישי צבאי:</label>
        <input type="text" name="idfnumber" placeholder="הכנס מספר אישי צבאי" class="form-control" required style="text-align: right;">
      </div>  
      <div class="form-group">    
        <label for="to" style="text-align: right;">יצאתי מ:</label>
        <select id="to" name="to" class="form-control" required onchange="updateFromField()" style="text-align: right;">
          <option value="">יצאתי מ:</option>
          <option value="בסיס">בסיס</option>
          <option value="בית">בית</option>
        </select>
      </div>  
      <div class="form-group">    
        <label for="from" style="text-align: right;">הגעתי ל:</label>
        <select id="from" name="from" class="form-control" required onchange="updateToField()" style="text-align: right;">
          <option value="">הגעתי ל:</option>
          <option value="בסיס">בסיס</option>
          <option value="בית">בית</option>
        </select>
      </div>  
      <button type="submit" class="btn btn-primary btn-block">שלח פרטים</button>
    </form>

  </div>
</div>

<div class="row">
  <div class="col-md-8 offset-md-2">

    <h2 class="text-center my-4">רשומות מידע</h2>
    <button id="btn-export"><b>Export as XLSX</b></button>
    <table id="recordsTable" class="table table-bordered">
      <thead>
        <tr dir="rtl">
          <th>נוצר בתאריך</th>
          <th>אל:</th>
          <th>מ:</th>
          <th>מספר צבאי</th>
          <th>שם</th>
          <th>ID</th>
        </tr> 
      </thead>
      <tbody></tbody>
    </table>

  </div>
</div>

  <script>
    function fetchRecords() {
      const url = 'https://felmomyinwjzbtvfyalv.supabase.co/rest/v1/records?select=*';
      const apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlbG1vbXlpbndqemJ0dmZ5YWx2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTY5NjcxNDg0NywiZXhwIjoyMDEyMjkwODQ3fQ.NByj9GFB3SvVseGCBbSoYYOdMvmVyr0Vbd-4GuxAMOU';
      const authorizationHeader = `Bearer ${apiKey}`;
      const apiRequestOptions = {
        headers: {
          'apikey': apiKey,
          'Authorization': authorizationHeader
        }
      };

      fetch(url, apiRequestOptions)
        .then(response => response.json())
        .then(data => {
          const tableBody = document.querySelector('#recordsTable tbody');
          tableBody.innerHTML = ''; // Clear existing table rows

          data.forEach(record => {
  const row = document.createElement('tr');

  const createdAt = new Date(record.created_at);

  const day = createdAt.getUTCDate().toString().padStart(2, '0');
  const month = (createdAt.getUTCMonth() + 1).toString().padStart(2, '0');
  const year = createdAt.getUTCFullYear();
  const hours = createdAt.getUTCHours().toString().padStart(2, '0');
  const minutes = createdAt.getUTCMinutes().toString().padStart(2, '0');
  const seconds = createdAt.getUTCSeconds().toString().padStart(2, '0');

  const formattedDate = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;

  row.innerHTML = `

  `;
  tableBody.appendChild(row);
});
groupTableByDays(data, tableBody);
        })
        .catch(error => {
          console.log('An error occurred while fetching records:', error.message);
        });
    }

    function submitData(event) {
      event.preventDefault(); // Prevent form submission

      const url = 'https://felmomyinwjzbtvfyalv.supabase.co/rest/v1/records';
      const apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlbG1vbXlpbndqemJ0dmZ5YWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTY3MTQ4NDcsImV4cCI6MjAxMjI5MDg0N30.GZ-k-aHnR7NFQR0vnL2s3TDeyDVLMqT5RkStP_LeQHQ';
      const authorizationHeader = `Bearer ${apiKey}`;
      const contentTypeHeader = 'application/json';
      const preferHeader = 'return=minimal';

      const form = document.getElementById("myForm");
      const formData = new FormData(form);

      const jsonData = {};
      formData.forEach(function(value, key) {
        jsonData[key] = value;
      });

      const requestOptions = {
        method: 'POST',
        headers: {
          'Content-Type': contentTypeHeader,
          'Prefer': preferHeader,
          'Authorization': authorizationHeader,
          'apikey': apiKey
        },
        body: JSON.stringify(jsonData)
      };

      fetch(url, requestOptions)
        .then(response => {
          if (response.ok) {
            console.log('Data inserted successfully');
            form.reset(); // Reset the form
            fetchRecords(); // Fetch and display all records
          } else {
            throw new Error('Data insertion failed');
          }
        })
        .catch(error => {
          console.log('An error occurred:', error.message);
        });
    }

    document.getElementById("myForm").addEventListener("submit", submitData);

    // Fetch and display records when the page loads
    fetchRecords();

    function groupTableByDays(records, tableBody) {
  // Group records by day
  const recordsByDay = {};
  records.forEach(record => {
    const createdAt = new Date(record.created_at);
    const dayKey = `${createdAt.getUTCDate()}-${createdAt.getUTCMonth() + 1}-${createdAt.getUTCFullYear()}`;

    if (!recordsByDay.hasOwnProperty(dayKey)) {
      recordsByDay[dayKey] = [];
    }

    recordsByDay[dayKey].push(record);
  });

  // Create table rows for each day group
  for (const dayKey in recordsByDay) {
    const records = recordsByDay[dayKey];

    // Create a group header row
    const groupRow = document.createElement('tr');
    groupRow.innerHTML = `<td class="day-group" colspan="6">${dayKey}</td>`;
    tableBody.appendChild(groupRow);

    // Create individual rows for each record in the group
    records.forEach(record => {
      const row = document.createElement('tr');

      const createdAt = new Date(record.created_at);

      const day = createdAt.getUTCDate().toString().padStart(2, '0');
      const month = (createdAt.getUTCMonth() + 1).toString().padStart(2, '0');
      const year = createdAt.getUTCFullYear();
      const hours = createdAt.getUTCHours().toString().padStart(2, '0');
      const minutes = createdAt.getUTCMinutes().toString().padStart(2, '0');
      const seconds = createdAt.getUTCSeconds().toString().padStart(2, '0');

      const formattedDate = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;

      row.innerHTML = `
      <td>${formattedDate}</td>
  <td>${record.from}</td>
  <td>${record.to}</td>
  <td>${record.idfnumber}</td>
  <td>${record.name}</td>
  <td>${record.id}</td>
      `;
      tableBody.appendChild(row);
    });
  }
}

function updateFromField() {
    var toField = document.getElementById("to");
    var fromField = document.getElementById("from");

    if (toField.value === "בסיס") {
      fromField.value = "בית";
    }
    if (toField.value === "בית") {
      fromField.value = "בסיס";
    }
    
  }

  function updateToField() {
    var toField = document.getElementById("to");
    var fromField = document.getElementById("from");

    if (fromField.value === "בסיס") {
      toField.value = "בית";
    }
    if (fromField.value === "בית") {
      toField.value = "בסיס";
    }
  }
  const exportButton = document.getElementById('btn-export');

const table = document.getElementById('recordsTable');

exportButton.addEventListener('click', () => {
  /* Create worksheet from HTML DOM TABLE */
  const wb = XLSX.utils.table_to_book(table, {sheet: 'sheet-1'});

  /* Export to file (start a download) */
  XLSX.writeFile(wb, 'MyTable.xlsx');
});
  </script>
      <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
</body>
</html>